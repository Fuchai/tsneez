<html>
    <body>

      <div id="embed"></div>
      <div id="cost" style="text-align:left; font-family: Impact;"></div>

      <script src="https://code.jquery.com/jquery-1.12.4.min.js"
              integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ="
              crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.min.js" integrity="sha256-dsOXGNHAo/syFnazt+KTBsCQeRmlcW1XKL0bCK4Baec=" crossorigin="anonymous"></script>
      <!--<script type="text/javascript" src="dist/streaming-tsne.js"></script>-->
      <script type="text/javascript" src="//cs.stanford.edu/people/karpathy/tsnejs/tsne.js"></script>
      <script type="text/javascript" src="streaming-tsne.js"></script>
      <script type="text/javascript">

var T = new tsne.TSNE(); // create a tSNE instance

var data;

function updateEmbedding() {
  var Y = T.Y;
  svg.selectAll('.u')
    .data(data.words)
    .attr("transform", function(d, i) { return "translate(" +
                                          ((Y.get(i, 0)*20*ss + tx) + 400) + "," +
                                          ((Y.get(i, 1)*20*ss + ty) + 400) + ")"; });
}

var svg;
function drawEmbedding() {
    $("#embed").empty();
    var div = d3.select("#embed");

    // get min and max in each column of Y
    var Y = T.Y;

    svg = div.append("svg") // svg is global
    .attr("width", 800)
    .attr("height", 800);

    var g = svg.selectAll(".b")
      .data(data.words)
      .enter().append("g")
      .attr("class", "u");

    g.append("text")
      .attr("text-anchor", "top")
      .attr("font-size", 12)
      .attr("fill", "#333")
      .text(function(d) { return d; });

    var zoomListener = d3.behavior.zoom()
      .scaleExtent([0.1, 10])
      .center([0,0])
      .on("zoom", zoomHandler);
    zoomListener(svg);
}

var tx=0, ty=0;
var ss=1;
function zoomHandler() {
  tx = d3.event.translate[0];
  ty = d3.event.translate[1];
  ss = d3.event.scale;
}

var stepHandle;
var stepnum = 0;
var tic = performance.now()
function step() {
  if(T.iter < 500) {
    var cost = T.step();
  }
  var fps = Math.round((T.iter / (performance.now() - tic)) * 1000);
  $("#cost").html("iteration " + T.iter + ", fps: " + fps + ", cost: " + cost);
  updateEmbedding();

  if (stepnum > 5) {
    clearInterval(stepHandle);
  }
}

$(window).load(function() {
  $.getJSON( "wordvecs50dtop1000.json", function( j ) {
    let tic, toc
    data = j;
    // data.words = data.words.splice(0, 100);
    // data.vecs = data.vecs.splice(0, 100);

    tic = performance.now()
    T.initData(data.vecs); // init embedding  WITH SUBSET
    toc = performance.now()
    console.log('streaming:', toc - tic)

    // compare with karpathy's tSNE
    let Tkarpathy = new tsnejs.tSNE();
    console.log(Tkarpathy);
    tic = performance.now()
    Tkarpathy.initDataRaw(data.vecs);
    toc = performance.now()
    console.log('karpathy:', toc - tic)
    /*
    const n = Math.sqrt(Tkarpathy.P.length);
    for (let i = 0; i < n; i++) {
      for (let j = i + 1; j < n; j++) {
        if (Math.abs(Tkarpathy.P[i*n+j] - T.P.get(i, j)) > 1e-5) {
          console.log('bad', Tkarpathy.P[i*n+j], T.P.get(i, j))
        }
      }
    }
    */
    drawEmbedding(); // draw initial embedding
    stepHandle = setInterval(step, 0);
    step();
  });
});

        </script>
    </body>
</html>
